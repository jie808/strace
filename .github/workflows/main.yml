name: Build strace for Android ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout strace source
        uses: actions/checkout@v4
        with:
          repository: strace/strace
          ref: master # 或者指定具体版本如 v6.12

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Android NDK
        uses: android-actions/setup-android@v3

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool make git xz-utils

      - name: Build strace for ARM64
        run: |
          # 1. 自动查找 NDK 路径
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls -1 $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          echo "Using NDK at: $NDK_PATH"
          
          # 2. 定义交叉编译环境变量
          # 我们使用 API 29 (Android 10)，具有较好的现代特性支持
          API_LEVEL=29
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC=$TOOLCHAIN/bin/aarch64-linux-android$API_LEVEL-clang
          export AS=$CC
          export LD=$TOOLCHAIN/bin/ld.lld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          # 3. 解决你遇到的编译错误：禁用 -Werror
          # 重点：strace 源码在某些 NDK 版本下会触发 nonnull 警告，必须禁用 Werror 才能继续
          export CFLAGS="-g -O2 -Wno-error"
          export LDFLAGS="-static"

          # 4. 生成配置脚本
          ./bootstrap

          # 5. 执行 Configure
          # --enable-mpers=check 处理 32/64 位兼容性检查
          ./configure --host=aarch64-linux-android \
                      --prefix=$(pwd)/output \
                      --enable-mpers=check \
                      CFLAGS="$CFLAGS" \
                      LDFLAGS="$LDFLAGS"

          # 6. 编译并安装到 output 目录
          make -j$(nproc)
          make install

      - name: Upload strace Binary
        uses: actions/upload-artifact@v4
        with:
          name: strace-6.x-android-arm64
          path: output/bin/strace

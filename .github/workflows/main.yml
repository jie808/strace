name: Build strace with Stack Trace (ARM64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout strace
        uses: actions/checkout@v4
        with:
          repository: strace/strace
          path: strace
          ref: master

      - name: Checkout libunwind
        uses: actions/checkout@v4
        with:
          repository: libunwind/libunwind
          path: libunwind
          ref: v1.6.2

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool make git xz-utils pkg-config

      - name: Build strace for Android ARM64
        run: |
          # 1. 环境准备
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls -1 $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          API_LEVEL=29
          
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC=$TOOLCHAIN/bin/aarch64-linux-android$API_LEVEL-clang
          export AS=$CC
          export LD=$TOOLCHAIN/bin/ld.lld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          INSTALL_DIR=$(pwd)/deps_install
          mkdir -p $INSTALL_DIR

          # ---------------------------------------------------------
          # 2. 编译 libunwind
          # ---------------------------------------------------------
          cd libunwind
          autoreconf -i
          
          ./configure --host=aarch64-linux-android \
                      --prefix=$INSTALL_DIR \
                      --disable-tests \
                      --enable-static \
                      --disable-shared \
                      --disable-coredump \
                      --disable-minidebuginfo \
                      --disable-zlib-debuginfo \
                      CFLAGS="-g -O2 -Wno-error" \
                      CPPFLAGS="-Din_addr_t=uint32_t"
          
          make -j$(nproc)
          make install
          cd ..

          # ---------------------------------------------------------
          # 3. 编译 strace
          # ---------------------------------------------------------
          cd strace
          ./bootstrap
          
          # 核心修复点：
          # 1. 设置 PKG_CONFIG_PATH 让 configure 自动发现 libunwind
          # 2. 手动补充 LIBS 确保探测函数时链接成功
          # 3. 强制使用静态链接路径
          export PKG_CONFIG_PATH=$INSTALL_DIR/lib/pkgconfig
          export CPPFLAGS="-I$INSTALL_DIR/include -Din_addr_t=uint32_t"
          export LDFLAGS="-L$INSTALL_DIR/lib -static"
          export LIBS="-lunwind-ptrace -lunwind -lunwind-aarch64"

          ./configure --host=aarch64-linux-android \
                      --prefix=$(pwd)/output \
                      --enable-mpers=check \
                      --with-libunwind \
                      CFLAGS="-g -O2 -Wno-error" \
                      CPPFLAGS="$CPPFLAGS" \
                      LDFLAGS="$LDFLAGS" \
                      LIBS="$LIBS"

          make -j$(nproc)
          make install
          
          # 确认二进制文件是否成功集成
          if grep -q "HAVE_LIBUNWIND 1" src/config.h; then
              echo "SUCCESS: libunwind integrated!"
          else
              echo "ERROR: libunwind NOT found in config.h. Build failed to enable stack trace."
              exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: strace-arm64-stacktrace
          path: strace/output/bin/strace

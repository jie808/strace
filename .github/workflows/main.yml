name: Build strace with Stack Trace (ARM64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        run: |
          git clone --depth=1 https://github.com/strace/strace.git strace_src
          git clone --depth=1 -b v1.6.2 https://github.com/libunwind/libunwind.git libunwind_src

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool make git xz-utils pkg-config

      - name: Build strace for Android ARM64
        run: |
          # 1. 设置 NDK 工具链
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls -1 $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          
          export TARGET=aarch64-linux-android
          export API=29
          export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          # 2. 定位 NDK 内部的静态 libz.a (这是解决 uncompress 的核心)
          # NDK 的 sysroot 下有针对不同架构的库文件
          LIBZ_PATH=$TOOLCHAIN/sysroot/usr/lib/$TARGET/$API/libz.a
          if [ ! -f "$LIBZ_PATH" ]; then
            # 兼容性路径查找
            LIBZ_PATH=$TOOLCHAIN/sysroot/usr/lib/$TARGET/libz.a
          fi
          echo "Found libz.a at: $LIBZ_PATH"
          
          export COMMON_FLAGS="-g -O2 -Wno-error -Din_addr_t=uint32_t"
          DEPS_DIR=$(pwd)/deps_install
          mkdir -p $DEPS_DIR

          # ---------------------------------------------------------
          # 3. 编译 libunwind
          # ---------------------------------------------------------
          cd libunwind_src
          autoreconf -i
          ./configure --host=$TARGET \
                      --prefix=$DEPS_DIR \
                      --enable-static \
                      --disable-shared \
                      --disable-coredump \
                      --disable-tests \
                      --disable-minidebuginfo \
                      --disable-lzma \
                      CFLAGS="$COMMON_FLAGS" \
                      LDFLAGS="-static"
          make -j$(nproc)
          make install
          cd ..

          # ---------------------------------------------------------
          # 4. 编译 strace (手动强行链接 libz.a)
          # ---------------------------------------------------------
          cd strace_src
          ./bootstrap
          
          # 在 LIBS 环境变量中直接填入 libz.a 的绝对路径，防止 ld.lld 漏掉
          # 顺序：ptrace -> generic -> unwind -> z
          UNWIND_LIBS="-L$DEPS_DIR/lib -lunwind-ptrace -lunwind-aarch64 -lunwind $LIBZ_PATH"
          UNWIND_CFLAGS="-I$DEPS_DIR/include"

          ./configure --host=$TARGET \
                      --prefix=$(pwd)/output \
                      --enable-mpers=check \
                      --with-libunwind \
                      ac_cv_lib_unwind_backtrace=yes \
                      libunwind_CFLAGS="$UNWIND_CFLAGS" \
                      libunwind_LIBS="$UNWIND_LIBS" \
                      CFLAGS="$COMMON_FLAGS" \
                      CPPFLAGS="-I$DEPS_DIR/include -Din_addr_t=uint32_t" \
                      LDFLAGS="-static -L$DEPS_DIR/lib" || { cat config.log; exit 1; }

          # 这里的 LIBS 赋值是为了确保最终链接 strace 时能带上 zlib
          make -j$(nproc) LIBS="$UNWIND_LIBS"
          make install
          
          echo ">>> Final Check for symbols:"
          $TOOLCHAIN/bin/llvm-nm src/strace | grep -E "unwind|uncompress" | head -n 10

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: strace-android-arm64-fixed
          path: strace_src/output/bin/strace

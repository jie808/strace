name: Build strace with Stack Trace (ARM64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout strace
        uses: actions/checkout@v4
        with:
          repository: strace/strace
          path: strace

      - name: Checkout libunwind
        uses: actions/checkout@v4
        with:
          repository: libunwind/libunwind
          path: libunwind
          ref: v1.6.2

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool make git xz-utils pkg-config

      - name: Build Components
        run: |
          # 1. 精确配置 NDK 路径
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls -1 $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          SYSROOT=$TOOLCHAIN/sysroot
          API_LEVEL=29
          TARGET=aarch64-linux-android
          
          # 关键：Clang 交叉编译必须包含 --sysroot 和 --target
          # 注意：NDK 23+ 的二进制文件名里已经包含了 target 和 api，所以直接用
          export CC=$TOOLCHAIN/bin/${TARGET}${API_LEVEL}-clang
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip
          
          # 定义全局编译参数
          export COMMON_FLAGS="-g -O2 -Wno-error -Din_addr_t=uint32_t"
          export LDFLAGS="-static"
          
          DEPS_DIR=$(pwd)/deps_install
          mkdir -p $DEPS_DIR

          # ---------------------------------------------------------
          # 2. 编译 libunwind
          # ---------------------------------------------------------
          echo "=== Building libunwind ==="
          cd libunwind
          autoreconf -i
          # 如果 configure 失败，cat config.log 能让我们看到具体的编译器报错
          ./configure --host=$TARGET \
                      --prefix=$DEPS_DIR \
                      --enable-static \
                      --disable-shared \
                      --disable-coredump \
                      --disable-tests \
                      CFLAGS="$COMMON_FLAGS" \
                      LDFLAGS="$LDFLAGS" || (cat config.log && exit 1)
          
          make -j$(nproc)
          make install
          cd ..

          # ---------------------------------------------------------
          # 3. 编译 strace
          # ---------------------------------------------------------
          echo "=== Building strace ==="
          cd strace
          ./bootstrap
          
          # 注入 libunwind 变量，绕过 pkg-config 探测
          export libunwind_CFLAGS="-I$DEPS_DIR/include"
          export libunwind_LIBS="-L$DEPS_DIR/lib -lunwind-ptrace -lunwind-aarch64 -lunwind"

          ./configure --host=$TARGET \
                      --prefix=$(pwd)/output \
                      --enable-mpers=check \
                      --with-libunwind \
                      CFLAGS="$COMMON_FLAGS" \
                      CPPFLAGS="-I$DEPS_DIR/include -Din_addr_t=uint32_t" \
                      LDFLAGS="$LDFLAGS -L$DEPS_DIR/lib" \
                      libunwind_CFLAGS="$libunwind_CFLAGS" \
                      libunwind_LIBS="$libunwind_LIBS" || (cat config.log && exit 1)

          make -j$(nproc)
          make install

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: strace-arm64-stacktrace
          path: strace/output/bin/strace

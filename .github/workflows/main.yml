name: Build strace for Android ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout strace source
        uses: actions/checkout@v4
        with:
          repository: strace/strace
          # 如果你确定要 6.19，可以指定 ref，但目前建议用 master 或 v6.12
          ref: master 

      - name: Set up JDK (Required for NDK tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install Android NDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool make git

      - name: Build strace for ARM64
        run: |
          # 1. 设置环境变量 (NDK 路径通常在 $ANDROID_SDK_ROOT/ndk-bundle 或通过环境变量获取)
          # 这里我们直接寻找最新的 NDK 版本
          NDK_PATH=$ANDROID_SDK_ROOT/ndk/$(ls -1 $ANDROID_SDK_ROOT/ndk | sort -V | tail -n 1)
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          
          # 2. 配置交叉编译工具链
          # Target 为 aarch64-linux-android，API Level 建议 21 (Android 5.0+) 或更高
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC=$TOOLCHAIN/bin/aarch64-linux-android29-clang
          export AS=$CC
          export LD=$TOOLCHAIN/bin/ld.lld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          # 3. 运行生成脚本
          ./bootstrap

          # 4. Configure
          # --host 指明运行平台，--enable-mpers=check 自动处理不同字长问题
          ./configure --host=aarch64-linux-android \
                      --prefix=$(pwd)/output \
                      --enable-mpers=check \
                      LDFLAGS="-static" # 静态链接方便在不同安卓版本直接运行

          # 5. 编译
          make -j$(nproc)
          make install

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: strace-android-arm64
          path: output/bin/strace
